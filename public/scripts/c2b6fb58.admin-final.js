angular.module("dashkiosk",["ngRoute","ngAnimate","mgcrea.ngStrap","xeditable","dashkiosk.services","dashkiosk.directives","dashkiosk.controllers"]),angular.module("dashkiosk").config(["$routeProvider",function(a){"use strict";a.when("/groups",{templateUrl:"groups.html",controller:"GroupsCtrl",resolve:{groups:["groupsService",function(a){return a()}]}}).otherwise({redirectTo:"/groups"})}]),angular.module("dashkiosk").run(["editableOptions","editableThemes",function(a,b){"use strict";b.bs3.inputClass="input-xs",b.bs3.buttonsClass="btn-xs",a.theme="bs3"}]),angular.module("dashkiosk").config(["$httpProvider",function(a){"use strict";a.interceptors.push("requestInterceptor")}]).factory("requestInterceptor",["$q","loadingIndicatorService",function(a,b){"use strict";return{request:function(c){return b.increment(),c||a.when(c)},requestError:function(c){return b.decrement(),a.reject(c)},response:function(c){return b.decrement(),c||a.when(c)},responseError:function(c){return b.decrement(),a.reject(c)}}}]),angular.module("dashkiosk").run(["$templateCache",function(a){"use strict";a.put("alerts.html",'<ul data-ui-element="dk-alerts">\n  <li ng-repeat="alert in alerts"\n      class="alert alert-{{ alert.level }} alert-dismissable">\n    <button type="button"\n            class="close"\n            ng-click="close($index)"\n            data-dismiss="alert"\n            aria-hidden="true">&times;</button>\n    <strong ng-show="alert.title">{{ alert.title }}</strong>\n    {{ alert.message }}\n  </li>\n</li>\n'),a.put("dashboard.edit.html",'<div class="modal" data-ui-element="dk-dashboard-edit" tabindex="-1" role="dialog">\n  <div class="modal-dialog">\n    <div class="modal-content" ng-controller="EditDashboardCtrl">\n      <form novalidate name="dashboardForm" class="form" role="form" ng-submit="submit()">\n        <div class="modal-body">\n          <div class="input-group" ng-class="{\'has-error\': dashboardForm.url.$invalid}"">\n            <span class="input-group-addon"><span title="URL" class="glyphicon glyphicon-link"></span></span>\n            <input type="url" class="form-control"\n                   placeholder="URL" name="url" required\n                   ng-model="dashboard.url">\n          </div>\n          <div class="input-group">\n            <span class="input-group-addon"><span title="Description" class="glyphicon glyphicon-book"></span></span>\n            <input type="text" class="form-control"\n                   placeholder="Description" name="description"\n                   ng-model="dashboard.description">\n          </div>\n          <div class="row">\n            <div class="col-md-6">\n              <div class="input-group">\n                <span class="input-group-addon"><span title="Timeout" class="glyphicon glyphicon-time"></span></span>\n                <input type="number" class="form-control"\n                       placeholder="Timeout" name="timeout"\n                       ng-model="dashboard.timeout">\n                <span class="input-group-addon">s</span>\n              </div>\n            </div>\n            <div class="col-md-6">\n              <div class="input-group">\n                <span class="input-group-addon"><span title="Viewport" class="glyphicon glyphicon-resize-full"></span></span>\n                <input type="text" class="form-control" viewport\n                       autocapitalize="off" autocorrect="off"\n                       placeholder="Viewport size (height × width)" name="viewport"\n                       ng-model="dashboard.viewport">\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="modal-footer">\n          <button type="button" class="btn btn-danger pull-left"\n                  ng-show="!isNew()"\n                  ng-click="delete()">\n            <span class="glyphicon glyphicon-trash"> Delete</span>\n          </button>\n          <button type="button" class="btn" ng-click="$hide()">Cancel</button>\n          <button type="submit" class="btn btn-primary"\n                  ng-disabled="!dashboardForm.$valid">Save</button>\n        </div>\n      </form>\n    </div>\n  </div>\n</div>\n'),a.put("dashboard.html",'<div data-ui-element="dk-dashboard" ng-class="{active: dashboard.active}">\n  <div class="properties">\n    <span class="property viewport"\n          bs-tooltip="\'Viewport\'"\n          ng-show="dashboard.viewport">\n      <span class="glyphicon glyphicon-resize-full"></span>\n      <em editable-text="dashboard.viewport"\n          buttons="no"\n          onbeforesave="dashboard.$update({viewport: $data || null})"\n          e-size="6">{{ dashboard.viewport }}</em>\n    </span>\n    <span class="property timeout"\n          bs-tooltip="\'Timeout\'"\n          ng-show="dashboard.timeout">\n      <span class="glyphicon glyphicon-time"></span>\n      <em editable-text="dashboard.timeout"\n          buttons="no"\n          onbeforesave="dashboard.$update({timeout: $data || null})"\n          e-size="3">{{ dashboard.timeout }}</em>s\n    </span>\n    <span class="property edit"\n                 bs-modal\n                 data-container="body"\n                 data-template="dashboard.edit.html">\n      <span class="glyphicon glyphicon-pencil"></span>\n    </span>\n    <span class="property move"\n          ng-class="{available: !$parent.$last}"\n          ng-click="dashboard.$update({rank: $parent.$index + 1})">\n      <span class="glyphicon glyphicon-chevron-down"></span>\n    </span>\n    <span class="property move"\n          ng-class="{available: !$parent.$first}"\n          ng-click="dashboard.$update({rank: $parent.$index - 1})">\n      <span class="glyphicon glyphicon-chevron-up"></span>\n    </span>\n  </div>\n  <div class="name">\n    <a href="{{ dashboard.url }}"\n       target="_blank"\n       title="{{ dashboard.url }}">{{ dashboard.description || dashboard.url }}</a>\n  </div>\n</div>\n'),a.put("display.edit.html",'<div class="modal" data-ui-element="dk-display-edit" tabindex="-1" role="dialog">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <div class="actions">\n          <span class="glyphicon glyphicon-screenshot"\n                bs-tooltip="display.osd?\'Hide name\':\'Show name\'"\n                ng-show="display.connected"\n                ng-click="display.$osd()"></span>\n          <span class="glyphicon glyphicon-refresh"\n                bs-tooltip="\'Reload\'"\n                ng-show="display.connected"\n                ng-click="display.$reload()"></span>\n        </div>\n        <h4 class="modal-title" ng-bind="display.name"></h4>\n        <span class="ip" ng-show="display.ip">{{ display.ip }}</span>\n      </div>\n      <form novalidate name="displayForm" class="form" role="form"\n            ng-controller="EditDisplayCtrl" ng-submit="submit()">\n        <div class="modal-body">\n          <div class="input-group">\n            <span class="input-group-addon"><span title="Description" class="glyphicon glyphicon-book"></span></span>\n            <input type="text" class="form-control"\n                   placeholder="Description" name="description"\n                   ng-model="display.description">\n          </div>\n          <div class="row">\n            <div class="col-md-6">\n              <div class="input-group" ng-class="{\'has-error\': displayForm.viewport.$invalid}">\n                <span class="input-group-addon"><span title="Viewport" class="glyphicon glyphicon-tag"></span></span>\n                <select class="form-control"\n                        name="group" required\n                        ng-options="g.id as g.name for (k, g) in groups"\n                        ng-model="display.group">\n                </select>\n              </div>\n            </div>\n            <div class="col-md-6">\n              <div class="input-group" ng-class="{\'has-error\': displayForm.viewport.$invalid}">\n                <span class="input-group-addon"><span title="Viewport" class="glyphicon glyphicon-resize-full"></span></span>\n                <input type="text" class="form-control" viewport\n                       autocapitalize="off" autocorrect="off"\n                       placeholder="Viewport size (height × width)" name="viewport"\n                       ng-model="display.viewport">\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="modal-footer">\n          <button type="button" class="btn btn-danger pull-left"\n                  ng-show="!display.connected"\n                  ng-click="delete()">\n            <span class="glyphicon glyphicon-trash"> Delete</span>\n          </button>\n          <button type="button" class="btn" ng-click="$hide()">Cancel</button>\n          <button type="submit" class="btn btn-primary"\n                  ng-disabled="!displayForm.$valid">Save</button>\n        </div>\n      </form>\n    </div>\n  </div>\n</div>\n'),a.put("display.html",'<div data-ui-element="dk-display"\n     dk-draggable="{{ display.name }}"\n     ng-class="{chromecast: !!display.chromecast}"\n     data-drag-type="text/vnd.dashkiosk.display">\n  <div class="screen"\n       ng-class="{on: display.connected, off: !display.connected, chromecast: !!display.chromecast}"\n       style="background-position: {{ backgroundOffset() }};"\n       bs-modal\n       data-container="body"\n       data-template="display.edit.html"\n       title="{{ display.description }}">\n    <div class="content">\n      <span class="name">{{ display.name }}</span>\n      <span class="description" ng-show="display.description">\n        {{ display.description }}\n      </span>\n    </div>\n  </div>\n</div>\n'),a.put("group.html",'<div data-ui-element="dk-group"\n     class="panel panel-default"\n     dk-droppable="attachDisplay"\n     data-drag-accept="text/vnd.dashkiosk.display">\n  <div class="panel-heading">\n    <div class="actions">\n      <span class="glyphicon glyphicon-trash"\n            bs-tooltip="\'Delete\'"\n            ng-show="group.$empty()"\n            ng-click="group.$delete()"></span>\n      <span class="glyphicon glyphicon-refresh"\n            bs-tooltip="\'Reload all\'"\n            ng-show="anyConnected()"\n            ng-click="reload()"></span>\n      <span class="glyphicon glyphicon-screenshot"\n            bs-tooltip="allOsd()?\'Hide names\':\'Show names\'"\n            ng-show="anyConnected()"\n            ng-click="toggleOsd()"></span>\n    </div>\n    <div class="name"\n         editable-text="group.name"\n         onbeforesave="group.$update({name: $data})"\n         e-placeholder="Group name">{{ group.name }}</div>\n    <div class="description"\n         editable-text="group.description"\n         onbeforesave="group.$update({description: $data})"\n         e-placeholder="Group description">{{ group.description || "..." }}</div>\n  </div>\n  <div class="panel-body">\n    <div class="displays">\n      <dk-display\n        ng-repeat="display in group.displays track by display.id | orderBy:[\'-connected\',\'name\']"\n        display="display" groups="groups">\n      </dk-display>\n    </div>\n  </div>\n  <div class="dashboards">\n    <dk-dashboard\n      ng-repeat="dashboard in group.dashboards track by dashboard.id"\n      dashboard="dashboard">\n    </dk-dashboard>\n    <div data-ui-element="dk-dashboard" class="add">\n      <button class="btn btn-sm"\n              bs-modal\n              data-container="body"\n              data-template="dashboard.edit.html">\n        <span class="glyphicon glyphicon-plus"></span>\n        Add a new dashboard\n      </button>\n    </div>\n  </div>\n</div>\n'),a.put("groups.html",'<ul data-ui-element="dk-group-list">\n  <li ng-repeat="group in groups track by group.id" class="col-md-6">\n    <dk-group group="group" groups="groups">\n    </dk-group>\n  </li>\n  <li class="col-md-2">\n    <button type="button"\n            class="btn btn-default btn-lg"\n            ng-click="createGroup()">\n      <span class="glyphicon glyphicon-plus"></span>\n      Add a new group\n    </button>\n  </li>\n</ul>\n'),a.put("loading.html",'<div data-ui-element="dk-loading-indicator"\n     ng-show="isBusy()" ng-transclude>\n</div>\n')}]),angular.module("dashkiosk.services",[]),angular.module("dashkiosk.services").factory("groupsService",["$window","$q","$http","$rootScope","loadingIndicatorService","alertService",function(a,b,c,d,e,f){"use strict";function g(){d.$apply(function(){r.client.applyDiff(r.server),console.debug("[Dashkiosk] current view",r.client)}),null!==p&&(p.resolve(r.client),p=null,q=!0)}function h(a,b,c,d,e,f){var g=_.keys(a),h=_.keys(b),i=_.difference(g,h),j=_.difference(h,g),k=_.intersection(g,h);_.each(i,c,f),_.each(j,d,f),_.each(k,e,f)}function i(){}function j(a){_.extend(this,a),this.displays=_.mapValues(this.displays,function(a){return new k(a)}),this.dashboards=new l(this.dashboards,this)}function k(a){_.extend(this,a)}function l(a,b){var c=[];return c.$add=l.prototype.$add,Object.defineProperty(c,"$add",{enumerable:!1,writable:!1}),c.applyDiff=l.prototype.applyDiff,Object.defineProperty(c,"applydiff",{enumerable:!1,writable:!1}),c.group=b,Object.defineProperty(c,"group",{enumerable:!1,writable:!0}),c.push.apply(c,_.map(a,function(a){return new m(a,b)})),c}function m(a,b){var c=_.extend(this,a);return c.group=b,Object.defineProperty(c,"group",{enumerable:!1,writable:!0}),c}var n=a.io,o=n.connect(a.location.origin+"/changes"),p=null,q=!1,r={server:{}};return e.increment(),o.on("connect",function(){console.info("[Dashkiosk] connected to socket.io server"),o.once("snapshot",function(){e.decrement()})}),o.on("disconnect",function(){console.warn("[Dashkiosk] lost connection to socket.io server"),e.increment()}),o.on("snapshot",function(a){console.info("[Dashkiosk] received a full snapshot of all groups"),r.server=a,g()}),o.on("group.created",function(a){console.info("[Dashkiosk] received a new group",a),r.server[a.id]=a,g()}),o.on("group.updated",function(a){console.info("[Dashkiosk] updated group",a),r.server[a.id]=a,g()}),o.on("group.deleted",function(a){console.info("[Dashkiosk] deleted group",a),delete r.server[a.id],g()}),o.on("display.updated",function(a){console.info("[Dashkiosk] updated display",a),_.each(r.server,function(b){b.displays=_.omit(b.displays,function(b){return b.name===a.name})});var b=r.server[a.group];b&&(b.displays[a.name]=a),g()}),o.on("display.deleted",function(a){console.debug("[Dashkiosk] deleted display",a),_.each(r.server,function(b){b.displays=_.omit(b.displays,function(b){return b.name===a.name})}),g()}),i.prototype.applyDiff=function(a){var b=this;h(b,a,function(a){delete b[a]},function(c){b[c]=new j(a[c])},function(c){b[c].applyDiff(a[c])})},i.prototype.$add=function(a){return c.post("api/group",a).then(function(){return!1}).catch(function(a){return f.danger("Unable to create new group!",((a||{}).data||{}).message),!1})},j.prototype.applyDiff=function(a){var b=this;h(_.omit(b,["displays","dashboards"]),_.omit(a,["displays","dashboards"]),function(a){delete b[a]},function(c){b[c]=a[c]},function(c){b[c]=a[c]}),b.dashboards.applyDiff(a.dashboards),h(b.displays,a.displays,function(a){delete b.displays[a]},function(c){b.displays[c]=new k(a.displays[c])},function(c){b.displays[c].applyDiff(a.displays[c])})},j.prototype.$update=function(a){return c.put("api/group/"+this.id,a).then(function(){return!1}).catch(function(a){return f.danger("Unable to update group!",((a||{}).data||{}).message),!1})},j.prototype.$delete=function(){return c.delete("api/group/"+this.id).then(function(){return!1}).catch(function(a){return f.danger("Unable to delete group!",((a||{}).data||{}).message),!1})},j.prototype.$attach=function(a){return c.put("api/display/"+a+"/group/"+this.id).then(function(){return!1}).catch(function(a){return f.danger("Unable to attach display!",((a||{}).data||{}).message),!1})},j.prototype.$empty=function(){return 0===_.keys(this.displays).length},k.prototype.applyDiff=function(a){var b=this;h(b,a,function(a){delete b[a]},function(c){b[c]=a[c]},function(c){b[c]=a[c]})},k.prototype.$update=function(a){return c.put("api/display/"+this.name,a).then(function(){return!1}).catch(function(a){return f.danger("Unable to update display!",((a||{}).data||{}).message),!1})},k.prototype.$delete=function(){return c.delete("api/display/"+this.name).then(function(){return!1}).catch(function(a){return f.danger("Unable to delete display!",((a||{}).data||{}).message),!1})},k.prototype.$action=function(a){return c.post("api/display/"+this.name+"/action",a).then(function(){return!1}).catch(function(a){return f.danger("Unable to trigger display action!",((a||{}).data||{}).message),!1})},k.prototype.$reload=function(){return this.$action({action:"reload"})},k.prototype.$osd=function(a){return this.$action({action:"osd",text:a===!0?this.name:a===!1?null:this.osd?null:this.name})},l.prototype.applyDiff=function(a){var b=this;_.each(a,function(a,c){var d=_.findIndex(b,{id:a.id});-1===d?b.splice(c,0,new m(a,b.group)):(d!==c&&b.splice(c,0,b.splice(d,1)[0]),b[c].applyDiff(a))}),b.splice(a.length)},l.prototype.$add=function(a){return c.post("api/group/"+this.group.id+"/dashboard",a).then(function(){return!1}).catch(function(a){return f.danger("Unable to create new dashboard",((a||{}).data||{}).message),!1})},m.prototype.applyDiff=function(a){var b=this;h(b,_.omit(a,"group"),function(a){delete b[a]},function(c){b[c]=a[c]},function(c){b[c]=a[c]})},m.prototype.$delete=function(){return c.delete("api/group/"+this.group.id+"/dashboard/"+this.id).then(function(){return!1}).catch(function(a){return f.danger("Unable to delete dashboard",((a||{}).data||{}).message),!1})},m.prototype.$update=function(a){return c.put("api/group/"+this.group.id+"/dashboard/"+this.id,a).then(function(){return!1}).catch(function(a){return f.danger("Unable to update dashboard",((a||{}).data||{}).message),!1})},r.client=new i,function(){return q?r.client:(null===p&&(p=b.defer()),p.promise)}}]),angular.module("dashkiosk.services").factory("loadingIndicatorService",["$timeout",function(a){"use strict";var b=0;return{increment:function(){a(function(){b+=1},0)},decrement:function(){a(function(){b-=1},0)},isBusy:function(){return b>0}}}]),angular.module("dashkiosk.services").factory("alertService",function(){"use strict";function a(a,b,d){void 0===d&&(d=b,b=void 0),c.push({level:a,title:b,message:d})}function b(a){c.splice(a,1)}var c=[],d=["danger","warning","success","info"],e=_.object(d,_.map(d,function(b){return function(c,d){a(b,c,d)}}));return e.close=b,e.alerts=c,e}),angular.module("dashkiosk.directives",[]),angular.module("dashkiosk.directives").directive("viewport",function(){"use strict";var a=/^\s*\d+\s*([x×]\s*\d+\s*)?$/;return{require:"ngModel",link:function(b,c,d,e){e.$parsers.unshift(function(b){return b?a.test(b)?(e.$setValidity("viewport",!0),b.replace(/\s+/g,"").replace(/×/,"x")):void e.$setValidity("viewport",!1):(e.$setValidity("viewport",!0),null)})}}}),angular.module("dashkiosk.directives").directive("dkLoadingIndicator",["loadingIndicatorService",function(a){"use strict";return{restrict:"E",replace:!0,transclude:!0,templateUrl:"loading.html",controller:["$scope",function(b){b.isBusy=a.isBusy}]}}]),angular.module("dashkiosk.directives").directive("dkAlerts",["alertService",function(a){"use strict";return{restrict:"E",replace:!0,templateUrl:"alerts.html",controller:["$scope",function(b){b.alerts=a.alerts,b.close=function(b){a.close(b)}}]}}]),angular.module("dashkiosk.directives").directive("dkGroup",function(){"use strict";return{restrict:"E",replace:!0,scope:{group:"=",groups:"="},templateUrl:"group.html",controller:"GroupCtrl"}}),angular.module("dashkiosk.directives").directive("dkDisplay",function(){"use strict";return{restrict:"E",replace:!0,scope:{display:"=",groups:"="},templateUrl:"display.html",controller:"DisplayCtrl"}}),angular.module("dashkiosk.directives").directive("dkDashboard",function(){"use strict";return{restrict:"E",replace:!0,scope:{dashboard:"="},templateUrl:"dashboard.html",controller:"DashboardCtrl"}}),angular.module("dashkiosk.directives").directive("dkDraggable",function(){"use strict";return{restrict:"A",link:function(a,b,c){b.attr("draggable","true").on("dragstart",function(a){b.addClass("dragged"),a.dataTransfer.effectAllowed="move",a.dataTransfer.setData(b.attr("data-drag-type"),c.dkDraggable)}).on("dragend",function(){b.removeClass("dragged")})}}}).directive("dkDroppable",function(){"use strict";return{restrict:"A",link:function(a,b,c){var d=function(a){var c=b.attr("data-drag-accept");return!c||_.contains(a.dataTransfer.types,c)},e=!1,f=!1;b.on("dragover",function(a){return d(a)?(a.preventDefault&&a.preventDefault(),!1):!0}).on("dragenter",function(a){return e?(f=!0,!0):(e=!0,d(a)?(b.addClass("droppable"),a.dataTransfer.effectAllowed="move",a.dataTransfer.dropEffect="move",!1):(a.dataTransfer.effectAllowed="none",a.dataTransfer.dropEffect="none",!0))}).on("dragleave",function(){return f?f=!1:e&&(e=!1),e||f?!0:(b.removeClass("droppable"),!1)}).on("drop",function(e){if(!d(e))return!0;e.stopPropagation&&e.stopPropagation(),b.removeClass("droppable");var f=a.$eval(c.dkDroppable);if("undefined"!=typeof f){var g=e.dataTransfer.getData(b.attr("data-drag-accept"));f(g||void 0)}return!1})}}}),angular.module("dashkiosk.controllers",[]),angular.module("dashkiosk.controllers").controller("GroupsCtrl",["$scope","groups",function(a,b){"use strict";a.groups=b,a.createGroup=function(){var a=function(a){for(var b,c=36,d="";d.length<a;)b=Math.random().toString(c).slice(2),d+=b.slice(0,Math.min(b.length,a-d.length));return d.toUpperCase()}(6);b.$add({name:"New group "+a,description:"Newly created group"})}}]),angular.module("dashkiosk.controllers").controller("GroupCtrl",["$scope",function(a){"use strict";a.attachDisplay=function(b){a.group.$attach(b)},a.anyConnected=function(){return _.any(a.group.displays,function(a){return a.connected})},a.reload=function(){_.each(a.group.displays,function(a){a.connected&&a.$reload()})},a.allOsd=function(){return _.all(a.group.displays,function(a){return!a.connected||a.osd})},a.toggleOsd=function(){var b=a.allOsd();_.each(a.group.displays,function(a){a.connected&&a.$osd(!b)})}}]),angular.module("dashkiosk.controllers").controller("DisplayCtrl",["$scope",function(a){"use strict";a.backgroundOffset=function(){if(!a.display.connected)return"0 0";var b,c=a.display.group,d=(_.find(a.groups[c].dashboards,{active:!0})||{}).id||-1,e=c+1,f=d+1;for(b=0;4>b;b++)f=36969*(65535&f)+(f>>>16),e=18e3*(65535&e)+(e>>>16);var g=(f<<16)+e;return"-"+(65535&g)%100+"% -"+(g>>>16)%100+"%"}}]).controller("EditDisplayCtrl",["$scope","$q",function(a,b){"use strict";var c=a.$parent.display,d=a.display=angular.copy(c);a.submit=function(){var e=_.omit(d,function(a,b){return"$"===b[0]?!0:a===c[b]?!0:!1}),f=b.defer(),g=f.promise;return _.isEmpty(_.omit(e,"group"))||g.then(function(){return c.$update(_.omit(e,"group"))}),_.has(e,"group")&&g.then(function(){return a.groups[e.group].$attach(c.name)}),g.then(function(){a.$hide()}),f.resolve(!0),g},a.delete=function(){a.$hide(),c.$delete()}}]),angular.module("dashkiosk.controllers").controller("DashboardCtrl",function(){"use strict"}).controller("EditDashboardCtrl",["$scope",function(a){"use strict";var b=a.$parent.dashboard,c=a.dashboard=angular.copy(b||{});a.submit=function(){if(b){var d=_.omit(c,function(a,c){return"$"===c[0]?!0:a===b[c]?!0:!1});b.$update(d).then(function(){a.$hide()})}else a.$parent.group.dashboards.$add(c).then(function(){a.$hide()})},a.delete=function(){b.$delete(),a.$hide()},a.isNew=function(){return!b}}]);